## 什么是共识机制

**区块链从本质上而言是一种分布式账本技术**。传统的账本，通常会以数据库的形式，集中存储在银行或公司的服务器节点上。而在区块链的网络中，**每个节点都会保有一份完整的账本，且所有节点的账本内容完全一致**。每个节点都可以根据自己本地的账本去查找交易，也可以往账本中添加交易。

这样就带来了一个问题，如果所有节点同时一起写入账本数据，那么肯定数据不会一致。因此需要**一种机制来保证区块链中的每一区块只能由一个节点来负责写入，并且让所有其他节点一致认同这次写入**，并且让所有其他节点一致认同这次写入。**如何选出写入账本数据的节点，这就是共识机制。**

### 拜占庭将军问题

拜占庭将军问题是对上述场景的一种建模。拜占庭将军问题是一个共识问题：首先由Leslie Lamport与另外两人在1982年提出，被称为The Byzantine Generals Problem或者Byzantine Failure。**核心描述是军中可能有叛徒，却要保证进攻一致**，由此引申到计算机领域，发展成了一种容错理论，即拜占庭容错(BFT,Byzantine Fault Tolerance)。

拜占庭将军问题描述如下：

```
拜占庭帝国想要进攻一个强大的敌人，为此派出了10支军队去包围这个敌人。这个敌人虽不比拜占庭帝国，但也足以抵御5支常规拜占庭军队的同时袭击。基于一些原因，这10支军队不能集合在一起单点突破，必须在分开的包围状态下同时攻击。他们任一支军队单独进攻都毫无胜算，除非有至少6支军队同时袭击才能攻下敌国。他们分散在敌国的四周，依靠通信兵相互通信来协商进攻意向及进攻时间。困扰这些将军的问题是，他们不确定他们中是否有叛徒，叛徒可能擅自变更进攻意向或者进攻时间。在这种状态下，拜占庭将军们能否找到一种分布式的协议来让他们能够远程协商，从而赢取战斗？这就是著名的拜占庭将军问题。
```

解决问题的难点在于，将军中可能出现叛徒，叛徒可以通过选择性地发送消息，从而达到混淆进攻决策的目的。假设有9位将军投票，其中1名叛徒。8名忠诚的将军中出现了4人投进攻，4人投撤离的情况。这时候叛徒可能故意给4名投进攻的将领送信表示投票进攻，而给4名投撤离的将领送信表示投撤离。这样一来在4名投进攻的将领看来，投票结果是5人投进攻，从而发起进攻；而在4名投撤离的将军看来则是5人投撤离。这样各支军队的一致协同就遭到了破坏。

拜占庭将军问题对应到分布式系统中，可以表述为分布式的节点间需要对某一个message达成共识（只要过半数节点认同这个message即可）。节点之间可以交换信息，但是由于恶意节点的存在，恶意节点会发布错误的消息，或是给不同的节点发送不同的消息。在这样的场景下，怎样设计一种机制去让节点能够达成共识的问题。

 ![img](https://user-gold-cdn.xitu.io/2018/4/2/1628577cde0fa40a?imageslim)

###  拜占庭问题的传统解法

#### 口头协议

首先明确口头协议的定义。我们将满足以下三个条件的方式称为口头协议：

```
1.每个被发送的消息都能够被正确的投递
2.信息接收者知道是谁发送的消息
3.能够知道缺少的消息
```

 Lamport论证得出结论：将军之间采用口头协议进行通信，若叛徒数少于1/3，则拜占庭将军问题可解。也就是说，**若叛徒数为m，当将军总数n至少为3m+1时，问题可解。**

### 书面协议

在口头协议上加上一个条件，使之成为书面协议

```
1.发送者对消息加上签名，签名不可伪造，一旦被篡改即可发现，而叛徒的签名可被其他叛徒伪造；
2.任何人都可以验证签名的可靠性。
```

可以论证，在将军之间使用书面协议通信的基础上，不管将军总数n和叛徒数量m，忠诚的将军总能达到一致。书面协议的本质就是引入了签名系统，这使得所有消息都可以追溯到底有谁认同了它。这一优势，大大节省了成本，他化解了口头协议中1/3要求，只要采用了书面协议，忠诚的将军就可以达到一致。即恶意的节点不超过半数，分布式系统就能达成共识。对推导细节感兴趣的读者可以同样参照。

### PBFT

实用拜占庭容错协议(PBFT,Practical Byzantine Fault Tolerance)解决了原始拜占庭容错算法(即上文中的口头协议)效率不高的问题，将算法复杂度由指数级降低到多项式级，使得拜占庭容错算法在实际系统应用中变得可行。

PBFT算法的结论是 n>=3f+1 n是系统中的总节点数，f是允许出现故障的节点数。换句话说，如果这个系统允许出现f个故障，那么这个系统必须包括n个节点，才能解决故障。这和上文口头协议的结论一样，或者这么说，PBFT是优化了口头协议机制的效率，但是结论并未改变。 

 PBFT算法的步骤

```
1.取一个副本作为主节点(图中0)，其他的副本作为备份；
2.用户(图中C)向主节点发送消息请求；
3.主节点通过广播将请求发送给其他节点(图1、2、3)；
4.所有主节点执行请求并将结果发回用户端；
5.用户端需要等待f+1个不同副本节点发回相同的结果，即可作为整个操作的最终结果。
```

![img](https://user-gold-cdn.xitu.io/2018/4/2/1628577bdd1ef73e?imageslim) 

### 比特币中对拜占庭问题的解法

拜占庭问题之所以难解，在于任何时候系统中都可能存在多个提案(因为提案成本很低)，并且要完成最终的一致性确认过程十分困难，容易受干扰。但是一旦确认，即为最终确认。

比特币的区块链网络在设计时提出了创新的PoW(Proof of Work)算法思路。**一个是限制一段时间内整个网络中出现提案的个数(增加提案成本)，另外一个是放宽对一致性确认的需求，**约定好大家都确认并沿着已知最长的链进行拓宽。系统的最终确认是概率意义上的存在。

PoS协议基于传统的拜占庭容错(BFT)模型，

## **什么是权益证明？**

权益证明将让整个挖矿过程虚拟化，并以验证者取代矿工。

以下是权益证明的运行过程：

- 验证者必须锁定一些他们拥有的币作为保证金。
- 在此之后，他们将开始验证区块。同时，当他们发现一个他们认为可以被加到链上的区块时，他们会通过下赌注来验证它。
- 如果该区块成功上链，验证者就将得到一个与他们的赌注成比例的奖励。
- 

### Casper权益证明算法

#### 投注共识

投注共识的核心思想：为验证人(validator)提供与协议对赌哪个块会被最终确定的机会。在这里对某个区块X的投注就是一笔交易，在所有区块X被处理了的世界中都会带给验证人Y个币的奖励(奖励是凭空“印”出来的，因而是“与协议”对赌)，而在所有区块X没有被处理的世界中会对验证人收取Z个币的罚款(罚金被销毁)。

(译注：一个世界(world)在这里应理解为区块链未来的一种可能状态。)

只有在相信区块X在人们关心的那个世界中被处理的可能性足够大时，这才是值得去做的交易，验证人才会愿意投注。然而，接下来就是经济上递归的有趣部分：人们关心的那个世界，也就是用户的客户端在用户想要知道他们的账户余额或是合约的状态时所展现的那个状态，本身就是根据人们对哪个区块投注最多推导出来的。因此，每一个验证人都具有根据他们所预期的其他人的投注情况进行投注的动机，驱使这个过程走向收敛。































